<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1,viewport-fit=cover">
<title>Mon Espace PRO ‚Äî DIGIY</title>
<meta name="theme-color" content="#022c22"/>

<style>
:root{
  --bg:#022c22;--bg2:#065f46;--card:#052e16;
  --accent:#facc15;--text:#e5e7eb;--muted:#9ca3af;
  --danger:#f97373;--ok:#22c55e;
  --line:rgba(148,163,184,.28);
  --glass:rgba(2,44,34,.35);
}
*{margin:0;padding:0;box-sizing:border-box}
body{
  min-height:100vh;
  display:flex;align-items:center;justify-content:center;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:
    radial-gradient(circle at top, rgba(250,204,21,.10), transparent 55%),
    linear-gradient(135deg,var(--bg),var(--bg2));
  color:var(--text);padding:20px;
}
.card{
  max-width:720px;width:100%;
  background:linear-gradient(145deg,rgba(5,46,22,.97),rgba(6,95,70,.96));
  border-radius:26px;border:1px solid rgba(15,118,110,.45);
  padding:22px;box-shadow:0 24px 60px rgba(0,0,0,.7);
}
.top{display:flex;justify-content:space-between;align-items:center;gap:12px}
.left{display:flex;gap:12px;align-items:center}
.ico{
  width:52px;height:52px;border-radius:50%;
  display:grid;place-items:center;
  background:radial-gradient(circle at 30% 0,#facc15,transparent 55%);
  color:#022c22;font-size:24px;font-weight:900;
  border:1px solid rgba(250,204,21,.35);
  box-shadow:0 0 20px rgba(250,204,21,.15);
}
h1{font-size:14px;letter-spacing:.14em}
.subtitle{font-size:12px;color:var(--muted)}
.pill{
  border:1px solid var(--line);
  background:rgba(250,204,21,.12);
  padding:8px 12px;border-radius:999px;
  font-weight:900;font-size:12px;cursor:pointer;
  user-select:none;
}
.pill:hover{border-color:rgba(250,204,21,.55)}
.sep{height:1px;background:var(--line);margin:14px 0}
#status{font-size:14px;color:var(--muted);font-weight:800}
#mini{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.4}
.ok{color:var(--ok)} .err{color:var(--danger)}
.grid{display:grid;gap:10px;margin-top:14px}
.btn{
  width:100%;padding:14px;
  background:var(--glass);border:1px solid var(--line);
  border-radius:16px;color:var(--text);
  display:flex;justify-content:space-between;align-items:center;
  cursor:pointer;font-weight:900;
}
.btn:hover{border-color:rgba(250,204,21,.6)}
.tag{
  padding:6px 10px;border-radius:999px;
  background:rgba(250,204,21,.12);
  border:1px solid rgba(250,204,21,.35);
  font-size:12px;font-weight:900;
}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.smallbtn{
  flex:1;min-width:220px;
  padding:12px 14px;border-radius:14px;
  background:rgba(0,0,0,.18);
  border:1px solid var(--line);
  color:var(--text);
  font-weight:900;cursor:pointer;
}
.smallbtn:hover{border-color:rgba(250,204,21,.55)}
.note{
  margin-top:12px;
  padding:12px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.12);
  border-radius:14px;
  color:rgba(229,231,235,.86);
  font-size:12px;line-height:1.5
}
.code{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size:12px;
  opacity:.9;
}
</style>

<!-- Supabase CDN (si tu l'utilises plus tard) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<div class="card">
  <div class="top">
    <div class="left">
      <div class="ico">ü¶Ö</div>
      <div>
        <h1>MON ESPACE PRO DIGIY</h1>
        <div class="subtitle" id="subtitle">Acc√®s PRO</div>
      </div>
    </div>
    <div class="pill" id="logout">D√©connexion</div>
  </div>

  <div class="sep"></div>

  <div id="status">Chargement‚Ä¶</div>
  <div id="mini"></div>

  <div class="row" id="quick" style="display:none">
    <button class="smallbtn" id="btnInscription">‚ûï Ajouter un module</button>
    <button class="smallbtn" id="btnRefresh">üîÑ Actualiser</button>
  </div>

  <div class="grid" id="modules"></div>

  <div class="note">
    <b>R√®gle DIGIY :</b> acc√®s cockpit uniquement via <b>PIN</b>.
    Une fois entr√©, tout reste ouvert. <b>0% commission</b>.<br>
    <span class="code">slug + phone</span> sont gard√©s et transmis aux modules.
  </div>
</div>

<script>
(async()=>{

  // =========================
  // ‚úÖ CONFIG DIGIY (√† toi)
  // =========================
  const ENTRY_URL = "https://beauville.github.io/inscription-digiy/";

  // ‚úÖ IMPORTANT : chaque module ouvre via pin.html
  const MODULES_URL = {
    DRIVER_PRO:  "https://beauville.github.io/digiy-driver-pro/pin.html",
    LOC_PRO:     "https://beauville.github.io/digiy-loc-pro/pin.html",
    MARKET_PRO:  "https://beauville.github.io/digiy-market-pro/pin.html",
    BUILD_PRO:   "https://beauville.github.io/digiy-build-pro/pin.html",
    JOBS_PRO:    "https://beauville.github.io/digiy-jobs-pro/pin.html",
    EXPLORE_PRO: "https://beauville.github.io/digiy-explore/pin.html"
  };

  // =========================
  // UI REFS
  // =========================
  const status = document.getElementById("status");
  const mini   = document.getElementById("mini");
  const grid   = document.getElementById("modules");
  const quick  = document.getElementById("quick");
  const subtitle = document.getElementById("subtitle");

  // =========================
  // HELPERS : phone + slug
  // - accepte ?phone= + ?slug= (venant de ROYAL)
  // - fallback localStorage
  // =========================
  function normPhone(p){
    if(!p) return "";
    let s = String(p).trim();
    s = s.replace(/[^\d+]/g, "");
    if (s && !s.startsWith("+")) {
      if (s.startsWith("221")) s = "+" + s;
    }
    return s;
  }

  function getUrlParam(name){
    try{ return (new URL(location.href)).searchParams.get(name) || ""; }catch(_){}
    return "";
  }

  // ‚úÖ NOS CLEFS (on garde les tiennes pour compat)
  const LS_PHONE = "digiy_phone";
  const LS_SLUG  = "digiy_slug";

  function getPhone(){
    return localStorage.getItem(LS_PHONE) || "";
  }
  function getSlug(){
    return localStorage.getItem(LS_SLUG) || "";
  }

  function setSession({phone, slug}){
    if(phone) localStorage.setItem(LS_PHONE, phone);
    if(slug)  localStorage.setItem(LS_SLUG, slug);
  }

  function clearSession(){
    localStorage.removeItem(LS_PHONE);
    localStorage.removeItem(LS_SLUG);
    // tes autres traces √©ventuelles
    localStorage.removeItem("DIGIY_LOC_PRO_SESSION");
    localStorage.removeItem("DIGIY_DRIVER_PRO_SESSION");
    localStorage.removeItem("DIGIY_BUILD_PRO_SESSION");
  }

  function goInscription(module){
    const u = new URL(ENTRY_URL);
    if(module) u.searchParams.set("module", module);
    // on transporte phone/slug si on les a
    const phone = getPhone();
    const slug  = getSlug();
    if(phone) u.searchParams.set("phone", phone);
    if(slug)  u.searchParams.set("slug", slug);
    location.href = u.toString();
  }

  // ‚úÖ construit URL module avec slug + phone + autres params (si tu en ajoutes plus tard)
  function buildModuleUrl(basePinUrl){
    const slug  = getSlug();
    const phone = getPhone();

    const dest = new URL(basePinUrl);
    if(slug)  dest.searchParams.set("slug", slug);
    if(phone) dest.searchParams.set("phone", phone);
    return dest.toString();
  }

  function addCard(title, sub, basePinUrl){
    const btn = document.createElement("div");
    btn.className = "btn";
    btn.innerHTML = `
      <div>
        <div style="font-size:14px">${title}</div>
        <div style="font-size:12px;opacity:.75;margin-top:4px">${sub}</div>
      </div>
      <span class="tag">ENTRER</span>
    `;

    btn.onclick = ()=>{
      const slug = getSlug();
      if(!slug){
        alert("‚ùå Aucun slug d√©tect√©. Passe par l‚Äôinscription.");
        return;
      }
      location.href = buildModuleUrl(basePinUrl);
    };

    grid.appendChild(btn);
  }

  // =========================
  // ‚úÖ START : capter params ROYAL
  // =========================
  const urlPhone = normPhone(getUrlParam("phone"));
  const urlSlug  = (getUrlParam("slug") || "").trim();

  // si ROYAL nous envoie phone/slug -> on les sauve
  if(urlPhone || urlSlug){
    setSession({ phone: urlPhone, slug: urlSlug });
  }

  // session finale
  const phone = getPhone();
  const slug  = getSlug();

  // =========================
  // UI LOGOUT / QUICK
  // =========================
  document.getElementById("btnInscription").onclick = ()=>goInscription("");
  document.getElementById("btnRefresh").onclick = ()=>location.reload();

  document.getElementById("logout").onclick = ()=>{
    if(!confirm("D√©connexion ?")) return;
    clearSession();
    location.reload();
  };

  // =========================
  // SI PAS D'ACCES
  // =========================
  if(!phone || !slug){
    subtitle.textContent = "Acc√®s PRO";
    status.innerHTML = "<span class='err'>Aucun acc√®s d√©tect√©</span>";
    mini.innerHTML = "Passe par l‚Äôinscription DIGIY pour cr√©er ton espace PRO.";
    grid.innerHTML = "";
    addCard("üìù Aller √† l‚Äôinscription", "Cr√©er ton acc√®s + paiement Wave", ENTRY_URL);
    return;
  }

  // =========================
  // OK : afficher session
  // =========================
  subtitle.textContent = `${phone} ‚Ä¢ ${slug}`;
  quick.style.display = "flex";

  status.innerHTML = "<span class='ok'>Cockpit pr√™t</span>";
  mini.innerHTML = "Choisis ton module actif üëë";
  grid.innerHTML = "";

  // =========================
  // MODULES
  // =========================
  addCard("üöó DRIVER PRO", "Chauffeur ‚Äî cockpit direct", MODULES_URL.DRIVER_PRO);
  addCard("üè† LOC PRO", "H√©bergement ‚Äî planning + pulse", MODULES_URL.LOC_PRO);
  addCard("üèóÔ∏è BUILD PRO", "Artisans ‚Äî devis terrain", MODULES_URL.BUILD_PRO);
  addCard("üõí MARKET PRO", "Boutique ‚Äî caisse + QR", MODULES_URL.MARKET_PRO);
  addCard("üíº JOBS PRO", "Emploi ‚Äî accompagnement", MODULES_URL.JOBS_PRO);
  addCard("üß≠ EXPLORE PRO", "Tourisme ‚Äî spots + boost", MODULES_URL.EXPLORE_PRO);

})();
</script>

</body>
</html>
